<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/blokdbit_logo_icon.png" type="image/png">
  <title>BLOKDBIT Web Flasher</title>

  <!-- ESP Web Tools -->
  <script src="https://unpkg.com/esp-web-tools@9.1.0/dist/web/install-button.js"></script>

  <!-- ESP Web Flasher: UMD version -->
  <script src="https://unpkg.com/esp-web-flasher@9.1.0/dist/web/index.umd.js"></script>

  <script>
    // Wait until espWebFlasher is defined
    window.addEventListener("DOMContentLoaded", () => {
      if (window.espWebFlasher) {
        window.ESPLoader = window.espWebFlasher.ESPLoader;
        window.WebSerialTransport = window.espWebFlasher.WebSerialTransport;
        console.log("‚úÖ ESP Web Flasher loaded and globals assigned");
      } else {
        console.error("‚ùå espWebFlasher UMD not loaded correctly.");
      }
    });
  </script>

  <style>
    /* ...existing styles... */
  </style>
</head>
<body>
  <!-- ...existing HTML content... -->

  <script>
    function togglePopup(id) {
      document.getElementById(id).classList.toggle("show");
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle("light-mode");
      document.body.style.backgroundColor = isDark ? "#fff" : "#1a1a1a";
      document.body.style.color = isDark ? "#000" : "#fff";
      document.getElementById("themeToggle").innerText = isDark ? "‚òÄÔ∏è" : "üåô";
    }

    let device;

    async function connectDevice() {
      try {
        device = await navigator.serial.requestPort();
        await device.open({ baudRate: 115200 });
        document.getElementById("deviceStatus").innerText = "üü¢ Connected";

        // ‚úÖ Enable model dropdown
        const modelDropdown = document.getElementById("deviceModel");
        if (modelDropdown) {
          modelDropdown.disabled = false;
          log("Model selector enabled.");
        }

        log("Device connected successfully.");
      } catch (error) {
        log("Failed to connect to device.");
      }
    }

    async function eraseDevice() {
      if (!device) return log("\n‚ùå No device connected. Connect first!");
      if (!window.WebSerialTransport) {
        log("\n‚ùå WebSerialTransport is not defined. Ensure esp-web-flasher is loaded correctly.");
        return;
      }
      log("\nErasing firmware...");
      try {
        const transport = new WebSerialTransport(device);
        const esploader = new ESPLoader(transport, "esp32", false);
        await transport.connect();
        await esploader.initialize();
        await esploader.erase_flash();
        await transport.disconnect();
        log("\n‚úî Firmware erased successfully!");
      } catch (error) {
        log("\n‚ùå Error erasing firmware: " + error.message);
      }
    }

    async function uploadFirmware() {
      if (!device) return log("\n‚ùå No device connected. Connect first!");
      const firmwareUrl = document.getElementById("firmwareVersion").value;
      log("\nDownloading firmware...");
      try {
        const response = await fetch(firmwareUrl);
        const firmwareData = await response.arrayBuffer();
        log("\nUploading firmware to device...");
        const writer = device.writable.getWriter();
        await writer.write(new Uint8Array(firmwareData));
        writer.releaseLock();
        log("\n‚úî Firmware uploaded successfully! Device is now ready.");
      } catch (error) {
        log("\n‚ùå Error uploading firmware: " + error.message);
      }
    }

    function saveConfig() {
      const config = {
        wifiSSID: document.getElementById("wifiSSID").value,
        wifiPassword: document.getElementById("wifiPassword").value,
        city: document.getElementById("city").value,
        timezone: document.getElementById("timezone").value,
        deviceModel: document.getElementById("deviceModel").value
      };
      log("\nConfig saved: " + JSON.stringify(config, null, 2));
    }

    function updateFirmwareOptions() {
      const model = document.getElementById("deviceModel").value;
      const firmwareDropdown = document.getElementById("firmwareVersion");
      firmwareDropdown.innerHTML = "";

      const firmwareOptions = {
        Matrix: [
          { name: "BlokdBit Matrix v1.1", url: "https://bitcoinmanor.github.io/BlokdBit-Matrix/BlokdBit_Matrix_FINAL_SKETCH4Flasher.ino.nodemcu-32s.bin" }
        ],
        Spark: [
          { name: "BlokdBit Spark Beta", url: "https://example.com/spark-firmware.bin" }
        ],
        Pulse: [],
        Edge: [],
        Infinity: []
      };

      firmwareOptions[model].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.url;
        option.text = opt.name;
        firmwareDropdown.appendChild(option);
      });
    }

    function log(message) {
      const logContainer = document.getElementById("log");
      logContainer.innerText += message + "\n";
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function downloadLog() {
      const logContent = document.getElementById("log").innerText;
      const blob = new Blob([logContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blokdbit_log.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = updateFirmwareOptions;
  </script>
</body>
</html>
