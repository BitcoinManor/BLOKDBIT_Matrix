<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/blokdbit_logo_icon.png" type="image/png">
  <title>BLOKDBIT Web Flasher</title>

  <!-- Include esptool-js -->
  <script src="https://cdn.jsdelivr.net/npm/esptool-js/dist/index.min.js"></script>

  <script>
    async function updateFirmwareOptions() {
      const modelDropdown = document.getElementById("deviceModel");
      if (!modelDropdown) {
        console.error("‚ùå deviceModel element not found when updating firmware options.");
        return;
      }

      const firmwareDropdown = document.getElementById("firmwareVersion");
      firmwareDropdown.innerHTML = "";

      const firmwareOptions = {
        Matrix: [
          { name: "BlokdBit Matrix v1.1", url: "https://bitcoinmanor.github.io/BlokdBit-Matrix/BlokdBit_Matrix_FINAL_SKETCH4Flasher.ino.nodemcu-32s.bin" }
        ],
        Spark: [
          { name: "BlokdBit Spark Beta", url: "https://example.com/spark-firmware.bin" }
        ],
        Pulse: [],
        Edge: [],
        Infinity: []
      };

      const selectedModel = modelDropdown.value;
      if (firmwareOptions[selectedModel]) {
        firmwareOptions[selectedModel].forEach(opt => {
          const option = document.createElement("option");
          option.value = opt.url;
          option.text = opt.name;
          firmwareDropdown.appendChild(option);
        });
      } else {
        console.error(`‚ùå No firmware options found for model: ${selectedModel}`);
      }
    }

    async function connectDevice() {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        document.getElementById("deviceStatus").innerText = "üü¢ Connected";
        log("Device connected successfully.");
        return port;
      } catch (error) {
        log("Failed to connect to device: " + error.message);
        throw error;
      }
    }

    async function eraseDevice() {
      try {
        const port = await connectDevice();
        const esptool = new ESPLoader(port);
        await esptool.initialize();
        log("Connected to device.");
        await esptool.eraseFlash();
        log("‚úî Firmware erased successfully!");
        await port.close();
      } catch (error) {
        log("‚ùå Error erasing firmware: " + error.message);
      }
    }

    async function uploadFirmware() {
      try {
        const port = await connectDevice();
        const firmwareUrl = document.getElementById("firmwareVersion").value;
        log("Downloading firmware...");
        const response = await fetch(firmwareUrl);
        const firmwareData = await response.arrayBuffer();
        const esptool = new ESPLoader(port);
        await esptool.initialize();
        log("Uploading firmware...");
        await esptool.flashData(new Uint8Array(firmwareData));
        log("‚úî Firmware uploaded successfully!");
        await port.close();
      } catch (error) {
        log("‚ùå Error uploading firmware: " + error.message);
      }
    }

    function log(message) {
      const logContainer = document.getElementById("log");
      logContainer.innerText += message + "\n";
      logContainer.scrollTop = logContainer.scrollHeight;
    }
  </script>
</head>
<body>
  <h1>BLOKDBIT Web Flasher</h1>
  <div>
    <label for="deviceModel">Device Model:</label>
    <select id="deviceModel" onchange="updateFirmwareOptions()">
      <option value="Matrix">Matrix</option>
      <option value="Spark">Spark</option>
      <option value="Pulse">Pulse</option>
      <option value="Edge">Edge</option>
      <option value="Infinity">Infinity</option>
    </select>
  </div>
  <div>
    <label for="firmwareVersion">Firmware Version:</label>
    <select id="firmwareVersion"></select>
  </div>
  <div>
    <button onclick="eraseDevice()">Erase Firmware</button>
    <button onclick="uploadFirmware()">Upload Firmware</button>
  </div>
  <div id="deviceStatus">üî¥ Not Connected</div>
  <pre id="log"></pre>
</body>
</html>
